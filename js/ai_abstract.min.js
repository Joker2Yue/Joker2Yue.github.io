!function(){const{randomNum:t,basicWordCount:e,btnLink:n,key:i,Referer:a,gptName:o,switchBtn:r,mode:l}=GLOBAL_CONFIG.postHeadAiDescription,{title:c,postAI:s,pageFillDescription:d}=GLOBAL_CONFIG_SITE;let y,m=!0,u=l,f=0,h=null,p=!1,g=null;const T=document.querySelector(".post-ai-description"),b=T.querySelector(".ai-title .anzhiyufont.anzhiyu-icon-arrow-rotate-right");let v=T.querySelector(".anzhiyu-icon-circle-dot");const E=T.querySelector(".ai-explanation");let k="",I="",L=600,M=0,A=0,w=[],S=0;const q=new IntersectionObserver(t=>{let e=t[0].isIntersecting;(m=e)&&(L=0===M?200:20,w[1]=setTimeout(()=>{A&&(M=0,A=0),0===M&&(E.innerHTML=k.charAt(0)),requestAnimationFrame(B)},L))},{threshold:0}),G=[function(){$("tianli"==u?"我是文章辅助AI: TianliGPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。":`我是文章辅助AI: ${o} GPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。`)},function(){b.click()},function(){M=0,A=1,P(),m=!1,S=0,E.innerHTML="生成中. . .",k="",I="",q.disconnect(),w[2]=setTimeout(()=>{E.innerHTML=function(){let t=document.querySelectorAll(".relatedPosts-list a");if(!t.length){const e=document.querySelector(".card-widget.card-recent-post");if(!e)return"";t=e.querySelectorAll(".aside-list-item a");let n="";for(let e=0;e<t.length;e++){const i=t[e];n+=`<div class="ai-recommend-item"><span class="index">${e+1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${i.href}')" title="${i.title}" data-pjax-state="">${i.title}</a></div>`}return`很抱歉，无法找到类似的文章，你也可以看看本站最新发布的文章：<br /><div class="ai-recommend">${n}</div>`}let e="";for(let n=0;n<t.length;n++){const i=t[n];e+=`<div class="ai-recommend-item"><span>推荐${n+1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${i.href}')" title="${i.title}" data-pjax-state="">${i.title}</a></div>`}return`推荐文章：<br /><div class="ai-recommend">${e}</div>`}()},600)},function(){$("正在前往博客主页...",!1),w[2]=setTimeout(()=>{window.pjax?pjax.loadUrl("/"):location.href=location.origin},1e3)}],x=T.querySelectorAll(".ai-btn-item");function B(t){if(m)if(B.start||(B.start=t),(S=t-B.start)>=20){if(B.start=t,M<I-1){let t=k.charAt(M+1),e=/[,.，。!?！？]/.test(t)?150:20;E.firstElementChild&&E.removeChild(E.firstElementChild),E.innerHTML+=t;let n=document.createElement("div");n.className="ai-cursor",E.appendChild(n),M++,150===e&&(T.querySelector(".ai-explanation .ai-cursor").style.opacity="0.2"),M===I-1&&(q.disconnect(),E.removeChild(E.firstElementChild)),w[0]=setTimeout(()=>{requestAnimationFrame(B)},e)}}else requestAnimationFrame(B)}function P(){w.forEach(t=>clearTimeout(t)),w=[]}function $(t,e=!0){M=0,A=1,P(),m=!1,S=0,q.disconnect(),E.innerHTML=e?"生成中. . .":"请等待. . .",I=(k=t).length,q.observe(T)}async function j(t=e){"tianli"===u?await async function(t){M=0,A=1,P(),m=!1,S=0,q.disconnect(),t=Math.max(10,Math.min(2e3,t));const e={key:i,Referer:a},n=(c+d).trim().substring(0,t),o={key:e.key,content:n,url:location.href},r={method:"POST",headers:{"Content-Type":"application/json",Referer:e.Referer},body:JSON.stringify(o)};console.info(n.length);try{let t,e=null;e&&clearInterval(e),e=setInterval(()=>{const t="生成中"+".".repeat(A);E.innerHTML=t,A=A%3+1},500);const n=await fetch("https://summary.tianli0.top/",r);let i;i=403===n.status?{summary:"403 refer与key不匹配。"}:500===n.status?{summary:"500 系统内部错误"}:await n.json(),t=i.summary.trim(),g=i.id,setTimeout(()=>{b.style.opacity="1"},300),$(t||"摘要获取失败!!!请检查Tianli服务是否正常!!!"),clearInterval(e)}catch(t){console.error(t),E.innerHTML="发生异常"+t}}(t):await async function(){const t=s.split(",").map(t=>t.trim());let e=0,n=-1;(()=>{try{if(e<3){e++;const i=1!==t.length?(()=>{let e=Math.floor(Math.random()*t.length);for(;e===n;)e=Math.floor(Math.random()*t.length);return n=e,t[e]})():t[0];$(i),b.style.opacity="0",setTimeout(()=>{b.style.opacity="1"},600)}else console.warn("连续点击次数超过限制，请稍后再试")}catch(t){console.error("生成AI摘要时发生错误:",t)}})()}()}Array.from(x).filter(t=>"go-tianli-blog"!==t.id).forEach((t,e)=>{t.addEventListener("click",()=>{G[e]()})}),document.getElementById("ai-tag").addEventListener("click",function(){"tianli"===u?(T.querySelectorAll(".ai-btn-item").forEach(t=>t.style.display="none"),document.getElementById("go-tianli-blog").style.display="block",$("你好，我是Tianli开发的摘要生成助理TianliGPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通，如果你也需要一个这样的AI摘要接口，可以在下方购买。")):(T.querySelectorAll(".ai-btn-item").forEach(t=>t.style.display="block"),document.getElementById("go-tianli-blog").style.display="none",$(`你好，我是本站摘要生成助理${o} GPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通。`))}),b.addEventListener("click",async function(){const n=(c+d).trim().substring(0,e);b.style.opacity="0.2",b.style.transitionDuration="0.3s",b.style.transform="rotate("+360*f+"deg)";let i=0;if(n.length<=e){let e=n.length-Math.floor(Math.random()*t);for(;(e===y||n.length-e===y)&&i<10;)e=n.length-Math.floor(Math.random()*t),i++;y=e,await j(e)}else{let a=Math.floor(Math.random()*t)+e;for(i=0;(a===y||n.length-a===y)&&i<10;)a=Math.floor(Math.random()*t)+e,i++;await j(a)}f++}),document.getElementById("go-tianli-blog").addEventListener("click",()=>{window.open(n,"_blank")}),v.addEventListener("click",async function(){if(!g)return void anzhiyu.snackbarShow("摘要还没加载完呢，请稍后。。。");if((v=T.querySelector(".anzhiyu-icon-circle-dot")).style.opacity="0.2",h&&!p)return h.pause(),p=!0,v.style.opacity="1",v.style.animation="",void(v.style.cssText="animation: ''; opacity: 1;cursor: pointer;");if(h&&p)return h.play(),p=!1,void(v.style.cssText="animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer");const t={key:i,Referer:a},e=new URLSearchParams({key:t.key,id:g}),n={method:"GET",headers:{"Content-Type":"application/json",Referer:t.Referer}};try{const t=await fetch(`https://summary.tianli0.top/audio?${e}`,n);if(403===t.status)console.error("403 refer与key不匹配。");else if(500===t.status)console.error("500 系统内部错误");else{const e=await t.blob(),n=URL.createObjectURL(e);(h=new Audio(n)).play(),v.style.cssText="animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer",h.addEventListener("ended",()=>{h=null,v.style.opacity="1",v.style.animation=""})}}catch(t){console.error("请求发生错误❎")}}),r&&document.getElementById("ai-Toggle").addEventListener("click",function(){"tianli"==(u="tianli"===u?"local":"tianli")?(document.getElementById("ai-tag").innerHTML="TianliGPT",v.style.opacity="1",v.style.cursor="pointer"):(v.style.opacity="0",v.style.cursor="auto",(document.getElementById("go-tianli-blog").style.display="block")&&(document.querySelectorAll(".ai-btn-item").forEach(t=>t.style.display="block"),document.getElementById("go-tianli-blog").style.display="none"),document.getElementById("ai-tag").innerHTML=o+" GPT");j()}),j(),document.getElementById("ai-tag").innerHTML="tianli"===u?"TianliGPT":o+" GPT"}();
